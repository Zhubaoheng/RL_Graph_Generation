# GRPO PyTorch Lightning è®­ç»ƒé…ç½®æ–‡ä»¶
# å‚è€ƒåŸå§‹é…ç½®ç»“æ„ï¼Œé€‚é…Lightningæ¡†æ¶

defaults:
  - _self_
  - general : general_default
  - train : train_default

# é€šç”¨é…ç½®
general:
    name : 'grpo_planar'
    gpus : 3
    swanlab: 'cloud'
    resume: null            # If resume, path to ckpt file from outputs directory in main directory
    test_only: null
    check_val_every_n_epochs: 2000
    sample_every_val: 1
    samples_to_generate: 40
    samples_to_save: 9
    chains_to_save: 1
    final_model_samples_to_generate: 40
    final_model_samples_to_save: 30
    final_model_chains_to_save: 0
    sample_steps: 1000

# æ•°æ®é›†é…ç½®
dataset:
  name: "planar"
  datadir: 'data/planar/'   # æ•°æ®ç›®å½•ï¼ˆç”¨äºå‚è€ƒæ•°æ®ï¼‰

train:
    seed: 0
    n_epochs: 100000
    batch_size: 64
    save_model: True
    n_workers: 32
sample:

    sample_steps: 100
    time_distortion: 'polydec'
    omega: 0.05
    eta: 50
    search: False           # 'all' | 'target_guidance' | 'distortion' | 'stochasticity' | False
    # fixed
    rdb: 'general'            # general | column | entry
    rdb_crit: dummy   
model:
    transition: 'marginal'                          # uniform, marginal, argmax, absorbfirst, absorbing
    model: 'graph_tf'
    extra_features: 'rrwp'        # 'all', 'cycles', 'eigenvalues', 'rrwp', 'rrwp_comp' or null
    rrwp_steps: 12
    n_layers: 10

    # Do not set hidden_mlp_E, dim_ffE too high, computing large tensors on the edges is costly
    # At the moment (03/08), y contains quite little information
    hidden_mlp_dims: { 'X': 128, 'E': 64, 'y': 128 }

    # The dimensions should satisfy dx % n_head == 0
    hidden_dims: { 'dx': 256, 'de': 64, 'dy': 64, 'n_head': 8, 'dim_ffX': 256, 'dim_ffE': 64, 'dim_ffy': 256 }
    lambda_train: [5, 0]   
# GRPOç‰¹å®šé…ç½®
grpo:
  # ===== é¢„è®­ç»ƒæ¨¡å‹ =====
  pretrained_checkpoint: "/home/ly/max/checkpoints/planar-59999-14h.ckpt"  # å¿…é¡»æŒ‡å®š
  ref_model_update_freq: 20000
  # ===== GRPOè®­ç»ƒå‚æ•°ï¼ˆä¼˜åŒ–åï¼‰=====
  learning_rate: 1e-7    # GRPOé€šå¸¸ä½¿ç”¨è¾ƒä½çš„å­¦ä¹ ç‡
  total_steps: 1000000000       # å‡å°‘æ€»è®­ç»ƒæ­¥æ•°ç”¨äºæµ‹è¯•
  save_every: 100           # æ¯100æ­¥ä¿å­˜ä¸€æ¬¡checkpoint

  # ===== GRPOç®—æ³•å‚æ•° =====
  group_size: 16            # æ¯ç»„çš„æ ·æœ¬æ•°ï¼ˆå°æ‰¹é‡é™ä½å†…å­˜ï¼‰
  num_groups: 3            # ç»„æ•°ï¼ˆå‡å°‘ä»¥é™ä½å†…å­˜ä½¿ç”¨ï¼‰
  kl_penalty: 0.001       # KLæ•£åº¦æƒ©ç½šç³»æ•° (å¤§å¹…é™ä½ï¼Œä¾‹å¦‚ä» 0.03 é™è‡³ 0.0001 æˆ–æ›´ä½)
  clip_ratio: 0.2          # PPOè£å‰ªæ¯”ä¾‹
  ent_coef: 0.1
  # ===== èŠ‚ç‚¹æ•°é…ç½®ï¼ˆå‡å°‘å†…å­˜ä½¿ç”¨ï¼‰=====
  target_node_count: 64    # è¿›ä¸€æ­¥å‡å°‘èŠ‚ç‚¹æ•°
  # node_count_range: [20, 40]  # æ–¹å¼2: èŠ‚ç‚¹æ•°èŒƒå›´
  # node_count_min: 20           # æ–¹å¼3: åˆ†åˆ«æŒ‡å®š
  # node_count_max: 40
  
  # ===== å¥–åŠ±å‡½æ•°é…ç½® =====
  reward_type: "intrinsic_quality"  # å¥–åŠ±å‡½æ•°ç±»å‹: default, planar_metrics
  target_density: 0.3      # ç›®æ ‡å›¾å¯†åº¦ï¼ˆä»…graph_propertyç±»å‹ä½¿ç”¨ï¼‰
  use_training_reference: true  # æ˜¯å¦ä½¿ç”¨è®­ç»ƒæ•°æ®ä½œä¸ºå‚è€ƒ
  
  # ===== ğŸ”§ æ€§èƒ½ä¼˜åŒ–å‚æ•° =====
  gradient_accumulation_steps: 1  # æ¢¯åº¦ç´¯ç§¯æ­¥æ•°
  gradient_clip_val: 1.0         # æ¢¯åº¦è£å‰ªå€¼
  reference_update_frequency: 1000 # å‚è€ƒæ¨¡å‹æ›´æ–°é¢‘ç‡ï¼ˆé™ä½é¢‘ç‡ï¼‰
  
  # ===== é‡‡æ ·/è¯„ä¼°æ¨¡å¼ =====
  # å¦‚æœè®¾ç½®äº†æ­¤è·¯å¾„ï¼Œå°†è¿›å…¥çº¯é‡‡æ ·æ¨¡å¼ï¼Œè€Œä¸æ˜¯è®­ç»ƒ
  sample_only: null # "/home/ly/max/checkpoints/planar-59999-14h.ckpt"
  num_samples_to_validate: 64 # åœ¨çº¯é‡‡æ ·æ¨¡å¼ä¸‹ç”Ÿæˆçš„æ ·æœ¬æ•°é‡
  
  # ===== Lightningç‰¹å®šé…ç½® =====
  log_every_n_steps: 10          # æ—¥å¿—è®°å½•é¢‘ç‡
  save_model: true               # æ˜¯å¦ä¿å­˜æ¨¡å‹

  resume_from_checkpoint: null   # GRPO checkpointè·¯å¾„
  


# Hydraé…ç½®
hydra:
  run:
    dir: outputs/${now:%Y-%m-%d}/${now:%H-%M-%S}
  job:
    chdir: true 